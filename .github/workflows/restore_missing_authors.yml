name: Restore Missing Authors in XML Files

on:
  workflow_dispatch:  # Manual trigger only - same as other workflows
    inputs:
      dry_run:
        description: 'Dry run (check only, no restoration)'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  restore_authors:
    runs-on: ubuntu-latest

    env:
      ES_CLOUD_ID: ${{ secrets.ES_CLOUD_ID }}
      ES_USERNAME: ${{ secrets.ES_USERNAME }}
      ES_PASSWORD: ${{ secrets.ES_PASSWORD }}
      ES_INDEX: ${{ secrets.ES_INDEX }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.10.x

    - name: Install dependencies
      run: |
        pip install --upgrade pip setuptools
        pip install -r requirements.txt

    - name: Debug - Check environment
      run: |
        echo "=========================================="
        echo "üîç DEBUGGING INFORMATION"
        echo "=========================================="
        echo "Current directory: $(pwd)"
        echo "Python version: $(python --version)"
        echo ""
        echo "Checking for required scripts:"
        ls -la check_missing_authors.py 2>/dev/null && echo "‚úÖ check_missing_authors.py found" || echo "‚ùå check_missing_authors.py NOT FOUND"
        ls -la restore_missing_authors.py 2>/dev/null && echo "‚úÖ restore_missing_authors.py found" || echo "‚ùå restore_missing_authors.py NOT FOUND"
        echo ""
        echo "Checking for static directory:"
        ls -la static/ 2>/dev/null && echo "‚úÖ static/ directory found" || echo "‚ùå static/ directory NOT FOUND"
        echo "=========================================="

    - name: Check current status (before restoration)
      run: |
        echo "=========================================="
        echo "üìä CHECKING CURRENT STATUS"
        echo "=========================================="
        python check_missing_authors.py
      continue-on-error: true

    - name: Run restoration script
      if: ${{ github.event.inputs.dry_run != 'true' }}
      run: |
        echo "=========================================="
        echo "üîß RESTORING MISSING AUTHORS"
        echo "=========================================="
        python restore_missing_authors.py

    - name: Check status after restoration
      if: ${{ github.event.inputs.dry_run != 'true' }}
      run: |
        echo "=========================================="
        echo "‚úÖ VERIFYING RESTORATION"
        echo "=========================================="
        python check_missing_authors.py
      continue-on-error: true

    - name: Configure Git
      if: ${{ github.event.inputs.dry_run != 'true' }}
      run: |
        git config user.email "${{ secrets.GIT_AUTHOR_EMAIL }}"
        git config user.name "${{ secrets.GIT_AUTHOR_NAME }}"

    - name: Commit and push changes
      if: ${{ github.event.inputs.dry_run != 'true' }}
      run: |
        echo "=========================================="
        echo "üíæ COMMITTING CHANGES"
        echo "=========================================="
        git add static/
        if git diff --staged --quiet; then
          echo "‚úÖ No changes to commit (all files already had authors)"
        else
          CHANGED_FILES=$(git diff --staged --name-only | wc -l)
          echo "üìù Committing $CHANGED_FILES changed files"
          git commit -m "fix: restore missing author tags in XML files" \
                     -m "" \
                     -m "- Restored author information for XML files missing <author> tags" \
                     -m "- Author data fetched from Elasticsearch" \
                     -m "- This fixes the issue where threading updater deleted authors" \
                     -m "" \
                     -m "Total files restored: Check workflow logs for details"
          git push
          echo "‚úÖ Changes pushed successfully!"
        fi

    - name: Summary
      if: always()
      run: |
        echo "=========================================="
        echo "üìã WORKFLOW SUMMARY"
        echo "=========================================="
        if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
          echo "üîç DRY RUN MODE - No changes were made"
          echo "Run without dry_run to actually restore files"
        else
          echo "‚úÖ Restoration workflow completed"
          echo "Check the logs above for detailed results"
        fi
        echo "=========================================="

